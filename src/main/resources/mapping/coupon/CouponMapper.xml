<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sysongy.poms.coupon.dao.CouponMapper">
	<resultMap id="BaseResultMap" type="com.sysongy.poms.coupon.model.Coupon">
		<id column="coupon_id" property="coupon_id" jdbcType="VARCHAR" />
		<result column="coupon_no" property="coupon_no" jdbcType="VARCHAR" />
		<result column="coupon_title" property="coupon_title" jdbcType="VARCHAR" />
		<result column="coupon_detail" property="coupon_detail" jdbcType="VARCHAR" />
		<result column="coupon_type" property="coupon_type" jdbcType="VARCHAR" />
		<result column="coupon_kind" property="coupon_kind" jdbcType="VARCHAR" />
		<result column="preferential_discount" property="preferential_discount" jdbcType="VARCHAR" />
		<result column="use_condition" property="use_condition" jdbcType="VARCHAR" />
		<result column="limit_money" property="limit_money" jdbcType="VARCHAR" />
		<result column="issuance_type" property="issuance_type" jdbcType="VARCHAR" />
		<result column="consume_type" property="consume_type" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="VARCHAR" />
		<result column="start_coupon_time" property="start_coupon_time" jdbcType="TIMESTAMP" />
		<result column="end_coupon_time" property="end_coupon_time" jdbcType="TIMESTAMP" />
		<result column="gas_station_name" property="gas_station_name" jdbcType="VARCHAR" />
		<result column="sys_gas_station_id" property="sys_gas_station_id" jdbcType="VARCHAR" />
	</resultMap>
	<resultMap id="UserCouponMap" type="com.sysongy.poms.coupon.model.UserCoupon">
		<id column="user_coupon_id" property="user_coupon_id" jdbcType="VARCHAR" />
		<result column="coupon_id" property="coupon_id" jdbcType="VARCHAR" />
		<result column="coupon_on" property="coupon_on" jdbcType="VARCHAR" />
		<result column="coupon_no" property="coupon_no" jdbcType="VARCHAR" />
		<result column="sys_driver_id" property="sys_driver_id" jdbcType="VARCHAR" />
		<result column="isuse" property="isuse" jdbcType="VARCHAR" />
		<result column="start_coupon_time" property="start_coupon_time" jdbcType="TIMESTAMP" />
		<result column="end_coupon_time" property="end_coupon_time" jdbcType="TIMESTAMP" />
		<result column="create_time" property="create_time" jdbcType="TIMESTAMP" />
		<result column="lastmodify_time" property="lastmodify_time" jdbcType="TIMESTAMP" />
		<result column="create_person_id" property="create_person_id" jdbcType="VARCHAR" />
		<result column="lastmodify_person_id" property="lastmodify_person_id" jdbcType="VARCHAR" />
	</resultMap>
	
	<sql id="Base_Column_List">
			sc.coupon_id,
			sc.coupon_no,
			sc.coupon_title,
			sc.coupon_detail,
			sc.coupon_type,
			sc.coupon_kind,
			sc.preferential_discount,
			sc.use_condition,
			sc.limit_money,
			sc.issuance_type,
			sc.consume_type,
			sc.STATUS,
				(
			SELECT
				gs.gas_station_name
			FROM
				`sys_gas_station` gs
			WHERE
				gs.sys_gas_station_id = sc.sys_gas_station_id
				) gas_station_name,
				sc.sys_gas_station_id,
			DATE_FORMAT(
				sc.start_coupon_time,
				'%Y-%m-%d'
			) start_coupon_time,
			DATE_FORMAT(sc.end_coupon_time, '%Y-%m-%d') end_coupon_time
	</sql>
	<select id="queryForPage" resultMap="BaseResultMap" parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from `sys_coupon` sc
		where 1=1
		<trim>
			<if test="coupon_no != null &amp;&amp; coupon_no != ''">
				and sc.coupon_no LIKE CONCAT(CONCAT('%',
				#{coupon_no,jdbcType=VARCHAR}), '%')
			</if>
			<if test="coupon_title != null &amp;&amp; coupon_title != ''">
				and sc.coupon_title LIKE CONCAT(CONCAT('%',
				#{coupon_title,jdbcType=VARCHAR}), '%')
			</if>
		    <if test="coupon_type != null &amp;&amp; coupon_type != ''">
		      and sc.coupon_type = #{coupon_type,jdbcType=VARCHAR}
		    </if>
		    <if test="coupon_kind != null &amp;&amp; coupon_kind != ''">
		      and sc.coupon_kind = #{coupon_kind,jdbcType=VARCHAR}
		    </if>
		   <if test="status != null &amp;&amp; status != ''">
		      and sc.status = #{status,jdbcType=VARCHAR}
		    </if>
		   <if test="sys_gas_station_id != null &amp;&amp; sys_gas_station_id != ''">
		      and sc.sys_gas_station_id = #{sys_gas_station_id,jdbcType=VARCHAR}
		    </if>
		</trim>
	</select>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.String">
		select
		<include refid="Base_Column_List" />
		from `sys_coupon` sc
		where sc.coupon_id = #{coupon_id,jdbcType=VARCHAR}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.String">
		delete from sys_coupon
		where coupon_id = #{coupon_id,jdbcType=VARCHAR}
	</delete>
	<insert id="insert" parameterType="com.sysongy.poms.coupon.model.Coupon">
		insert into sys_coupon (coupon_id,coupon_no, coupon_title, coupon_detail, coupon_type, coupon_kind,
		preferential_discount,limit_money,use_condition,issuance_type,consume_type,status,
		start_coupon_time, end_coupon_time,sys_gas_station_id,
		create_person_id,create_time,lastmodify_person_id,lastmodify_time
		)
		values (#{coupon_id,jdbcType=VARCHAR}, #{coupon_no,jdbcType=VARCHAR}, 
		 #{coupon_title,jdbcType=VARCHAR}, #{coupon_detail,jdbcType=VARCHAR},
		#{coupon_type,jdbcType=VARCHAR},#{coupon_kind,jdbcType=VARCHAR}, #{preferential_discount,jdbcType=VARCHAR},
		#{limit_money,jdbcType=VARCHAR},#{use_condition,jdbcType=VARCHAR},#{issuance_type,jdbcType=VARCHAR}, #{consume_type,jdbcType=VARCHAR},#{status,jdbcType=VARCHAR},
		 #{start_coupon_time,jdbcType=TIMESTAMP}, #{end_coupon_time,jdbcType=TIMESTAMP},#{sys_gas_station_id,jdbcType=VARCHAR},
		#{create_person_id,jdbcType=VARCHAR},#{create_time,jdbcType=TIMESTAMP},#{lastmodify_person_id,jdbcType=VARCHAR},#{lastmodify_time,jdbcType=TIMESTAMP}
		)
	</insert>
	<update id="updateByPrimaryKey" parameterType="com.sysongy.poms.coupon.model.Coupon">
		update sys_coupon
		set
		coupon_title = #{coupon_title,jdbcType=VARCHAR},
		coupon_detail = #{coupon_detail,jdbcType=VARCHAR},
		coupon_type = #{coupon_type,jdbcType=VARCHAR},
		coupon_kind = #{coupon_kind,jdbcType=VARCHAR},
		preferential_discount = #{preferential_discount,jdbcType=VARCHAR},
		limit_money = #{limit_money,jdbcType=VARCHAR},
		use_condition = #{use_condition,jdbcType=VARCHAR},
		issuance_type=#{issuance_type,jdbcType=VARCHAR},
		consume_type=#{consume_type,jdbcType=VARCHAR},
		status=#{status,jdbcType=VARCHAR},
		sys_gas_station_id=#{sys_gas_station_id,jdbcType=VARCHAR},
		start_coupon_time=#{start_coupon_time,jdbcType=TIMESTAMP},
		end_coupon_time=#{end_coupon_time,jdbcType=TIMESTAMP},
		lastmodify_person_id=#{lastmodify_person_id,jdbcType=VARCHAR},
		lastmodify_time=#{lastmodify_time,jdbcType=TIMESTAMP}
		where coupon_id = #{coupon_id,jdbcType=VARCHAR}
	</update>
	<select id="selectByUser_Coupon" resultMap="UserCouponMap"
		parameterType="java.lang.String">
			SELECT
			user_coupon_id,
			coupon_id,
			coupon_no,
			isuse,
			suc.user_coupon_id,
			suc.coupon_id,
			suc.coupon_no,
			suc.sys_driver_id,
			suc.start_coupon_time,
			suc.end_coupon_time,
			suc.isuse,
			sd.user_name,
			sd.full_name,
			sd.identity_card,
			sd.plate_number,
			sd.fuel_type,
			sd.station_id,
			sd.regis_source
			FROM
				`sys_user_coupon` suc
			LEFT JOIN `sys_driver` sd ON suc.sys_driver_id = sd.sys_driver_id
			WHERE
				1 = 1
		<trim>
			<if test="user_coupon_id != null &amp;&amp; user_coupon_id != ''">
				and suc.user_coupon_id = #{user_coupon_id,jdbcType=VARCHAR}
			</if>
		    <if test="coupon_id != null &amp;&amp; coupon_id != ''">
		      	and suc.coupon_id = #{coupon_id,jdbcType=VARCHAR}
		    </if>
		    <if test="sys_driver_id != null &amp;&amp; sys_driver_id != ''">
		      	and suc.sys_driver_id = #{sys_driver_id,jdbcType=VARCHAR}
		    </if>
		</trim>
	</select>
	<select id="selectByUserCouponByPK" resultMap="UserCouponMap"
		parameterType="java.lang.String">
			SELECT
			user_coupon_id,
			coupon_id,
			isuse,
			suc.user_coupon_id,
			suc.coupon_id,
			suc.sys_driver_id,
			suc.coupon_no,
			suc.isuse,
			suc.start_coupon_time,
			suc.end_coupon_time,
			sd.user_name,
			sd.full_name,
			sd.identity_card,
			sd.plate_number,
			sd.fuel_type,
			sd.station_id,
			sd.regis_source
			FROM
				`sys_user_coupon` suc
			LEFT JOIN `sys_driver` sd ON suc.sys_driver_id = sd.sys_driver_id
			WHERE
				1 = 1
		and  suc.user_coupon_id = #{user_coupon_id,jdbcType=VARCHAR}
	</select>
	<insert id="insertUserCoupon" parameterType="com.sysongy.poms.coupon.model.UserCoupon">
		insert into sys_user_coupon (user_coupon_id, coupon_id,coupon_no, sys_driver_id, isuse, coupon_kind,sys_gas_station_id,
		start_coupon_time, end_coupon_time,create_person_id,create_time,lastmodify_person_id,lastmodify_time
		)
		values (#{user_coupon_id,jdbcType=VARCHAR},#{coupon_id,jdbcType=VARCHAR},#{coupon_no,jdbcType=VARCHAR},#{sys_driver_id,jdbcType=VARCHAR},#{isuse,jdbcType=VARCHAR},#{coupon_kind,jdbcType=VARCHAR},#{sys_gas_station_id,jdbcType=VARCHAR},
		 #{start_coupon_time,jdbcType=TIMESTAMP}, #{end_coupon_time,jdbcType=TIMESTAMP},#{create_person_id,jdbcType=VARCHAR},#{create_time,jdbcType=TIMESTAMP},#{lastmodify_person_id,jdbcType=VARCHAR},#{lastmodify_time,jdbcType=TIMESTAMP}
		)
	</insert>
	<update id="updateUserCoupon" parameterType="com.sysongy.poms.coupon.model.UserCoupon">
		update sys_user_coupon
		set isuse = #{isuse,jdbcType=VARCHAR},
		lastmodify_person_id=#{lastmodify_person_id,jdbcType=VARCHAR},
		lastmodify_time=#{lastmodify_time,jdbcType=TIMESTAMP}
		where coupon_no = #{coupon_no,jdbcType=VARCHAR}
	</update>

	<!-- 当前用户可用优惠券 -->
	<select id="queryCouponOrderByAmount" resultMap="BaseResultMap" parameterType="com.sysongy.poms.coupon.model.Coupon">
		select sc.*,suc.user_coupon_id
		from sys_user_coupon suc left join sys_coupon sc on suc.coupon_id = sc.coupon_id
		where suc.isuse = '0' AND suc.sys_driver_id = #{driverId,jdbcType=VARCHAR} AND sc.status = 1
		AND (sc.sys_gas_station_id =  #{sys_gas_station_id,jdbcType=VARCHAR} OR sc.coupon_kind = 1)
		AND sc.start_coupon_time &lt;= CURDATE() AND sc.end_coupon_time &gt;= CURDATE()
		<trim>
			<if test="preferential_discount != null &amp;&amp; preferential_discount != ''">
				AND sc.preferential_discount &lt;= CONVERT(#{preferential_discount,jdbcType=VARCHAR},decimal)
				AND (sc.limit_money is null or sc.limit_money &lt;= CONVERT(#{preferential_discount,jdbcType=VARCHAR},decimal))
			</if>
		</trim>
		order by CONVERT(preferential_discount,decimal) DESC,use_condition DESC,end_coupon_time ASC
	</select>
	<!-- 查询当前用户所有优惠券 -->
	<select id="queryAllCouponForPage" resultMap="BaseResultMap" parameterType="java.lang.String">
		SELECT
			coupon_id,
			coupon_kind,
			coupon_type,
			use_condition,
			preferential_discount,
			start_coupon_time,
			end_coupon_time
		FROM sys_coupon
		WHERE
			coupon_id IN (
				SELECT
					coupon_id
				FROM
					sys_user_coupon
				WHERE
					isuse = '0'
				AND sys_user_coupon.sys_driver_id = #{driverId,jdbcType=VARCHAR}
			)
	</select>

	<select id="queryUserCouponByID" resultMap="UserCouponMap" parameterType="java.lang.String">
		select * from sys_user_coupon
		where isuse = '0' 
		and user_coupon_id = #{0}
		and sys_driver_id = #{1}
	</select>
</mapper>